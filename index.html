<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Inventario de Muebles</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- html5-qrcode -->
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    input, button {
      font-size: 1.2rem;
      padding: 12px;
    }
    .table-responsive {
      max-height: 400px;
      overflow-y: auto;
    }
  </style>
</head>
<body class="bg-light">

  <!-- Encabezado -->
  <header class="bg-primary text-white text-center py-4 mb-4 shadow">
    <h1 class="fw-bold fs-4">Inventario de Muebles</h1>
  </header>

  <div class="container">

    <!-- EscÃ¡ner -->
    <div class="card mb-4 shadow-sm">
      <div class="card-header bg-primary text-white">
        <h2 class="h6 mb-0">ðŸ“· EscÃ¡ner (Code128 / QR)</h2>
      </div>
      <div class="card-body text-center">
        <div id="reader" class="w-100 mb-3"></div>
        <input type="text" id="barcode" class="form-control mb-2" placeholder="CÃ³digo escaneado">
        <button class="btn btn-success w-100 mb-2" onclick="stopScanner()">Detener escaneo</button>
      </div>
    </div>

    <!-- Formulario -->
    <div class="card mb-4 shadow-sm">
      <div class="card-header bg-success text-white">
        <h2 class="h6 mb-0">âž• Registrar producto</h2>
      </div>
      <div class="card-body">
        <div class="mb-3">
          <input type="text" id="productName" class="form-control" placeholder="Nombre del producto">
        </div>
        <div class="mb-3">
          <input type="number" id="quantity" class="form-control" placeholder="Cantidad">
        </div>
        <button class="btn btn-success w-100" onclick="addToInventory()">Agregar al inventario</button>
      </div>
    </div>

    <!-- Barra mensual -->
    <div class="mb-4">
      <label>Registros de este mes:</label>
      <div class="progress">
        <div id="monthProgress" class="progress-bar" role="progressbar" style="width:0%">0 registros</div>
      </div>
    </div>

    <!-- Inventario -->
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-dark text-white">
        <h2 class="h6 mb-0">ðŸ“¦ Inventario</h2>
      </div>
      <div class="card-body p-0 table-responsive">
        <table class="table table-striped table-hover mb-0">
          <thead class="table-dark">
            <tr>
              <th>CÃ³digo</th>
              <th>Producto</th>
              <th>Cantidad</th>
              <th>Fecha</th>
            </tr>
          </thead>
          <tbody id="inventory"></tbody>
        </table>
      </div>
    </div>

    <!-- Exportar -->
    <button class="btn btn-primary w-100 mb-4" onclick="exportInventory()">ðŸ“¤ Exportar a CSV</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Cargar inventario desde LocalStorage
    let inventory = JSON.parse(localStorage.getItem('inventory')) || [];
    updateInventoryList();
    updateMonthProgress();

    // EscÃ¡ner con html5-qrcode
    const html5QrcodeScanner = new Html5Qrcode("reader");
    function startScanner() {
      html5QrcodeScanner.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        (decodedText, decodedResult) => {
          document.getElementById('barcode').value = decodedText;
        }
      ).catch(err => console.log(err));
    }

    function stopScanner() {
      html5QrcodeScanner.stop().then(() => console.log("Escaneo detenido"));
    }

    // Agregar producto al inventario
    function addToInventory() {
      const barcode = document.getElementById('barcode').value;
      const name = document.getElementById('productName').value;
      const quantity = parseInt(document.getElementById('quantity').value);
      const today = new Date().toISOString().split('T')[0]; // Fecha YYYY-MM-DD

      if (barcode && name && quantity) {
        const existingProduct = inventory.find(item => item.barcode === barcode);
        if (existingProduct) {
          existingProduct.quantity += quantity;
          existingProduct.date = today; // Actualizar fecha al Ãºltimo registro
        } else {
          inventory.push({ barcode, name, quantity, date: today });
        }

        // Guardar en LocalStorage
        localStorage.setItem('inventory', JSON.stringify(inventory));

        updateInventoryList();
        updateMonthProgress();

        // Limpiar campos
        document.getElementById('barcode').value = '';
        document.getElementById('productName').value = '';
        document.getElementById('quantity').value = '';
      }
    }

    // Actualizar tabla
    function updateInventoryList() {
      const list = document.getElementById('inventory');
      list.innerHTML = '';
      inventory.forEach(item => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${item.barcode}</td>
          <td>${item.name}</td>
          <td>${item.quantity}</td>
          <td>${item.date}</td>
        `;
        list.appendChild(row);
      });
    }

    // Actualizar barra mensual
    function updateMonthProgress() {
      const now = new Date();
      const currentMonth = now.getMonth();
      const currentYear = now.getFullYear();
      const monthItems = inventory.filter(item => {
        const date = new Date(item.date);
        return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
      });
      const percentage = Math.min((monthItems.length / 100) * 100, 100); // 100 registros referencia
      const progressBar = document.getElementById('monthProgress');
      progressBar.style.width = percentage + '%';
      progressBar.textContent = monthItems.length + ' registros';
    }

    // Exportar CSV
    function exportInventory() {
      if (inventory.length === 0) return alert("No hay productos para exportar.");
      const data = inventory.map(item => `${item.barcode},${item.name},${item.quantity},${item.date}`).join('\n');
      const blob = new Blob([data], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'inventario.csv';
      a.click();
      URL.revokeObjectURL(url);
    }

    // Inicia escÃ¡ner automÃ¡ticamente
    startScanner();
  </script>
</body>
</html>
