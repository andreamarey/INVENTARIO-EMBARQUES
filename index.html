<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Inventario ‚Äî Simple (KLL + SKU)</title>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
<style>
  :root{
    --primary:#2563eb; --primary-600:#1d4ed8;
    --bg:#f3f4f6; --card:#fff; --text:#111827; --muted:#6b7280;
    --ring:rgba(37,99,235,.15)
  }
  *{box-sizing:border-box}
  body { font-family: Arial, sans-serif; margin:0; background:var(--bg); color:var(--text); }
  header { background:var(--primary); color:#fff; padding:16px; text-align:center; font-weight:700; }
  .container { max-width:1000px; margin:20px auto; padding:10px; }
  .tabs { display:flex; gap:6px; margin-bottom:10px; flex-wrap:wrap; }
  .tab-btn { flex:1; min-width:150px; padding:10px; cursor:pointer; border:1px solid #e5e7eb; background:#fff; border-radius:8px; font-weight:700; }
  .tab-btn.active { background:var(--primary); color:#fff; border-color:var(--primary); }
  .card { background:#fff; border-radius:10px; padding:15px; margin-bottom:15px; box-shadow:0 2px 8px rgba(0,0,0,.06); }
  .hidden { display:none; }
  input,button,select { width:100%; padding:10px; margin:6px 0; border-radius:8px; border:1px solid #e5e7eb; background:#fff; color:var(--text); }
  input:focus,select:focus { outline:none; box-shadow:0 0 0 3px var(--ring); border-color:var(--primary); }
  button { background:var(--primary); color:#fff; border:none; cursor:pointer; font-weight:700; }
  button:hover { background:var(--primary-600); }
  .btn-secondary{ background:#6b7280; }
  .btn-secondary:hover{ background:#4b5563; }
  .row{display:flex; gap:10px; flex-wrap:wrap}
  .muted { color:var(--muted); font-size:.9rem; }
  ul{padding-left:18px}

  /* Etiqueta preview */
  .label-preview { border:1px solid #000; padding:12px; width:320px; background:#fff; border-radius:6px; }
  .model { font-size:20px; font-weight:700; }
  .fabric { font-size:16px; margin-top:2px; }
  .sku { font-size:14px; margin-top:2px; }
  .date { font-size:14px; margin-top:2px; }

  /* Historial agrupado */
  .group{margin:10px 0}
  .group h3{margin:0 0 6px 0; font-size:1rem}
  .mov{padding:6px 8px; border:1px solid #e5e7eb; border-radius:8px; margin:4px 0; background:#fff}
  .kv{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:.9rem}
</style>
</head>
<body>
<header>Inventario ‚Äî Simple (KLL + SKU)</header>
<div class="container">

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab-btn active" data-tab="registrar">Registrar</button>
    <button class="tab-btn" data-tab="inventario">Inventario</button>
    <button class="tab-btn" data-tab="etiquetas">Etiquetas</button>
    <button class="tab-btn" data-tab="config">Configuraci√≥n y Herramientas</button>
  </div>

  <!-- Registrar -->
  <section id="registrar" class="card">
    <h2>Registrar producto</h2>
    <div class="row">
      <input id="newName" placeholder="Modelo (ej. Sill√≥n Roma)">
      <input id="newFabric" placeholder="Tela (ej. Lino Beige)">
      <input id="newSKU" placeholder="SKU (ej. SR-LB)">
    </div>
    <button id="btnGenerate">Guardar / Sumar</button>
    <div class="muted">Si ya existe el mismo <b>SKU + Modelo + Tela</b>, se suma cantidad y se reutiliza el mismo KLL.</div>
  </section>

  <!-- Inventario -->
  <section id="inventario" class="card hidden">
    <h2>Inventario</h2>

    <div class="row">
      <input id="searchInput" placeholder="Buscar por modelo, tela, SKU o c√≥digo" oninput="renderInventory(); renderHistory();">
    </div>

    <div class="row" style="margin-top:6px">
      <label style="flex:1">Desde: <input type="date" id="dateFrom" onchange="renderInventory(); renderHistory();"></label>
      <label style="flex:1">Hasta: <input type="date" id="dateTo" onchange="renderInventory(); renderHistory();"></label>
    </div>

    <div class="row" style="margin-top:6px">
      <button onclick="exportFilteredTotals()">Exportar CSV (Totales Filtrados)</button>
      <button onclick="exportFilteredHistory()" class="btn-secondary">Exportar CSV (Historial Filtrado)</button>
    </div>

    <h3 style="margin-top:14px">Totales (filtrados)</h3>
    <ul id="inventory"></ul>

    <h3 style="margin-top:14px">Historial (movimientos filtrados)</h3>
    <div id="history" class="muted">No hay movimientos.</div>
  </section>

  <!-- Etiquetas -->
  <section id="etiquetas" class="card hidden">
    <h2>Etiquetas</h2>
    <div class="row">
      <select id="labelSelect" onchange="showPreview()"></select>
      <button id="btnPrint">Imprimir etiqueta</button>
    </div>
    <div id="previewWrap" style="margin-top:8px"></div>
    <div class="muted" style="margin-top:6px">Formato: Modelo (grande) ¬∑ Tela ¬∑ <b>SKU</b> ¬∑ Fecha ¬∑ C√≥digo de barras (KLL)</div>
  </section>

  <!-- Configuraci√≥n y Herramientas -->
  <section id="config" class="card hidden">
    <h2>Configuraci√≥n y Herramientas</h2>

    <h3>Importar / Exportar</h3>
    <div class="row">
      <input type="file" id="csvFile" accept=".csv">
      <button id="btnImport" class="btn-secondary">Importar CSV (requiere columna ‚ÄúC√≥digo‚Äù)</button>
    </div>
    <div class="row">
      <button id="btnExportTotals">Exportar CSV (Totales)</button>
      <button id="btnExportMovs" class="btn-secondary">Exportar CSV (Movimientos)</button>
    </div>

    <div class="muted" style="margin-top:8px">
      Formato CSV para importar (encabezados): <span class="kv">Modelo,Tela,SKU,Cantidad,C√≥digo,Fecha</span>.<br>
      Si falta <b>C√≥digo</b>, la fila se omite (se respeta tu pol√≠tica de c√≥digos).
    </div>
  </section>

</div>

<script>
/* ===== Estado & Persistencia ===== */
let items = [];     // [{code, sku, nombre, tela, cantidad, createdISO}]
let moves = [];     // [{dateISO, code, sku, nombre, tela, delta, type}] // type: 'register'|'import'
let kllCounter = 1;

(function load(){
  try{
    items = JSON.parse(localStorage.getItem('items_simple')||'[]');
    moves = JSON.parse(localStorage.getItem('moves_simple')||'[]');
    kllCounter = parseInt(localStorage.getItem('kllCounter_simple')||'1');
  }catch(e){ items=[]; moves=[]; kllCounter=1; }
  renderInventory();
  refreshLabelSelect();
})();
function saveAll(){
  localStorage.setItem('items_simple', JSON.stringify(items));
  localStorage.setItem('moves_simple', JSON.stringify(moves));
  localStorage.setItem('kllCounter_simple', String(kllCounter));
}

/* ===== Tabs muy simples ===== */
document.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('section').forEach(s=>s.classList.add('hidden'));
    document.getElementById(btn.dataset.tab).classList.remove('hidden');
    if(btn.dataset.tab==='etiquetas') refreshLabelSelect();
  });
});

/* ===== Registrar (SKU + KLL) ===== */
document.getElementById('btnGenerate').addEventListener('click', ()=>{
  const nombre = document.getElementById('newName').value.trim();
  const tela   = document.getElementById('newFabric').value.trim();
  const sku    = document.getElementById('newSKU').value.trim();
  if(!nombre || !tela || !sku){ alert("Completa Modelo, Tela y SKU"); return; }

  // Buscar si ya existe este SKU+Modelo+Tela
  const existing = items.find(i=>i.sku.toLowerCase()===sku.toLowerCase() &&
                                 i.nombre.toLowerCase()===nombre.toLowerCase() &&
                                 i.tela.toLowerCase()===tela.toLowerCase());
  const now = new Date();
  const nowISO = now.toISOString();

  if(existing){
    existing.cantidad += 1;
    moves.push({dateISO: nowISO, code: existing.code, sku: existing.sku, nombre: existing.nombre, tela: existing.tela, delta:+1, type:'register'});
    alert(`Se sum√≥ +1 a ${existing.nombre} (${existing.tela}) ¬∑ SKU ${existing.sku}\nC√≥digo: ${existing.code}`);
  }else{
    const code = "KLL-" + String(kllCounter).padStart(4,"0");
    kllCounter++;
    items.push({code, sku, nombre, tela, cantidad:1, createdISO:nowISO});
    moves.push({dateISO: nowISO, code, sku, nombre, tela, delta:+1, type:'register'});
    alert(`Nuevo producto creado con c√≥digo ${code}`);
  }
  saveAll();
  // limpiar
  document.getElementById('newName').value = "";
  document.getElementById('newFabric').value = "";
  document.getElementById('newSKU').value = "";
  renderInventory();
  refreshLabelSelect();
});

/* ===== Inventario: filtros de fecha + b√∫squeda + export ===== */
function parseInputDate(id){
  const el = document.getElementById(id);
  if(!el || !el.value) return null;
  return new Date(el.value + "T00:00:00");
}
function inRange(iso){
  if(!iso) return true;
  const d = new Date(iso);
  const from = parseInputDate('dateFrom');
  const to   = parseInputDate('dateTo');
  if(from && d < from) return false;
  if(to){
    const end = new Date(to.getTime()); end.setHours(23,59,59,999);
    if(d > end) return false;
  }
  return true;
}

function renderInventory(){
  const list = document.getElementById('inventory');
  if(!list) return;
  const q = (document.getElementById('searchInput')?.value || "").toLowerCase();
  list.innerHTML="";

  const data = items
    .filter(i=>{
      const okQ = !q || i.nombre.toLowerCase().includes(q) || i.tela.toLowerCase().includes(q) ||
                        (i.sku||"").toLowerCase().includes(q) || i.code.toLowerCase().includes(q);
      const okD = inRange(i.createdISO);
      return okQ && okD;
    })
    .sort((a,b)=>(b.createdISO||"").localeCompare(a.createdISO||""));

  if(data.length===0){ list.innerHTML = '<li class="muted">No hay resultados con el filtro actual.</li>'; return; }

  data.forEach(i=>{
    const dateTxt = i.createdISO ? new Date(i.createdISO).toLocaleDateString() : "";
    const li = document.createElement("li");
    li.innerHTML = `${escapeHtml(i.nombre)} - Tela: ${escapeHtml(i.tela)} - SKU: ${escapeHtml(i.sku||'')} - C√≥digo: ${escapeHtml(i.code)} - Cantidad: ${i.cantidad} - Fecha: ${escapeHtml(dateTxt)}`;
    list.appendChild(li);
  });

  // Actualiza historial tambi√©n
  renderHistory();
}

function renderHistory(){
  const box = document.getElementById('history');
  if(!box) return;
  const q = (document.getElementById('searchInput')?.value || "").toLowerCase();

  const rows = moves
    .filter(m=>{
      const okQ = !q || m.nombre.toLowerCase().includes(q) || m.tela.toLowerCase().includes(q) ||
                        (m.sku||"").toLowerCase().includes(q) || m.code.toLowerCase().includes(q);
      const okD = inRange(m.dateISO);
      return okQ && okD;
    })
    .sort((a,b)=>(b.dateISO||"").localeCompare(a.dateISO||""));

  if(rows.length===0){ box.innerHTML = '<div class="muted">No hay movimientos para este filtro.</div>'; return; }

  const groups = new Map(); // agrupa por d√≠a
  rows.forEach(r=>{
    const day = (r.dateISO||"").slice(0,10);
    if(!groups.has(day)) groups.set(day, []);
    groups.get(day).push(r);
  });

  let html = "";
  for(const [day, list] of groups){
    html += `<div class="group"><h3>üìÖ ${day.split('-').reverse().join('/')}</h3>`;
    list.forEach(r=>{
      const t = new Date(r.dateISO);
      const sign = r.delta>0? '+' : '';
      html += `
        <div class="mov">
          <div><b>${escapeHtml(r.nombre)}</b> ¬∑ ${escapeHtml(r.tela)} ¬∑ SKU ${escapeHtml(r.sku||'')}</div>
          <div class="muted">C√≥digo: ${escapeHtml(r.code)} ¬∑ ${t.toLocaleTimeString()}</div>
          <div class="kv">Œî ${sign}${r.delta} ¬∑ ${r.type}</div>
        </div>`;
    });
    html += `</div>`;
  }
  box.innerHTML = html;
}

function exportFilteredTotals(){
  const q = (document.getElementById('searchInput')?.value || "").toLowerCase();
  const rows = items
    .filter(i=>{
      const okQ = !q || i.nombre.toLowerCase().includes(q) || i.tela.toLowerCase().includes(q) ||
                        (i.sku||"").toLowerCase().includes(q) || i.code.toLowerCase().includes(q);
      const okD = inRange(i.createdISO);
      return okQ && okD;
    })
    .sort((a,b)=>(b.createdISO||"").localeCompare(a.createdISO||""));
  if(rows.length===0){ alert("No hay datos para exportar con el filtro actual."); return; }

  const headers = ["Modelo","Tela","SKU","C√≥digo","Cantidad","Fecha Alta"];
  const data = rows.map(i=>[
    i.nombre, i.tela, i.sku||"", i.code, i.cantidad,
    i.createdISO ? new Date(i.createdISO).toLocaleDateString() : ""
  ]);
  downloadCSV("inventario_totales_filtrado.csv", headers, data);
}

function exportFilteredHistory(){
  const q = (document.getElementById('searchInput')?.value || "").toLowerCase();
  const rows = moves
    .filter(m=>{
      const okQ = !q || m.nombre.toLowerCase().includes(q) || m.tela.toLowerCase().includes(q) ||
                        (m.sku||"").toLowerCase().includes(q) || m.code.toLowerCase().includes(q);
      const okD = inRange(m.dateISO);
      return okQ && okD;
    })
    .sort((a,b)=>(b.dateISO||"").localeCompare(a.dateISO||""));
  if(rows.length===0){ alert("No hay movimientos para exportar con el filtro actual."); return; }

  const headers = ["Fecha","Hora","C√≥digo","SKU","Modelo","Tela","Delta","Tipo"];
  const data = rows.map(m=>{
    const d = new Date(m.dateISO||Date.now());
    return [ d.toLocaleDateString(), d.toLocaleTimeString(), m.code, m.sku||"", m.nombre, m.tela, m.delta, m.type ];
  });
  downloadCSV("inventario_historial_filtrado.csv", headers, data);
}

/* ===== Etiquetas ===== */
function refreshLabelSelect(){
  const sel = document.getElementById('labelSelect');
  if(!sel) return;
  const prev = sel.value;
  sel.innerHTML = "";
  items.forEach(i=>{
    const opt = document.createElement('option');
    opt.value = i.code;
    opt.textContent = `${i.nombre} ¬∑ ${i.tela} ¬∑ SKU ${i.sku} ¬∑ ${i.code}`;
    sel.appendChild(opt);
  });
  if(prev && [...sel.options].some(o=>o.value===prev)) sel.value = prev;
  showPreview();
}
function showPreview(){
  const sel = document.getElementById('labelSelect');
  const wrap = document.getElementById('previewWrap');
  wrap.innerHTML = "";
  if(!sel || !sel.value) return;
  const it = items.find(i=>i.code===sel.value);
  if(!it) return;
  const dateTxt = it.createdISO ? new Date(it.createdISO).toLocaleDateString() : "";
  const div = document.createElement('div');
  div.className="label-preview";
  div.innerHTML = `
    <div class="model">${escapeHtml(it.nombre)}</div>
    <div class="fabric">Tela: ${escapeHtml(it.tela)}</div>
    <div class="sku">SKU: ${escapeHtml(it.sku)}</div>
    <div class="date">${escapeHtml(dateTxt)}</div>
    <svg id="barcodePrev"></svg>
  `;
  wrap.appendChild(div);
  try{ JsBarcode("#barcodePrev", it.code, {format:"CODE128", width:2, height:60, displayValue:true}); }catch(e){}
}
document.getElementById('btnPrint').addEventListener('click', ()=>{
  const sel = document.getElementById('labelSelect');
  if(!sel || !sel.value){ alert("Selecciona un producto"); return; }
  const it = items.find(i=>i.code===sel.value);
  if(!it){ alert("Producto no encontrado"); return; }
  const dateTxt = it.createdISO ? new Date(it.createdISO).toLocaleDateString() : "";
  const w = window.open('', '', 'width=420,height=360');
  const html = `
    <html><head><title>Etiqueta ${escapeHtml(it.code)}</title>
    <style>
      body{font-family:Arial, sans-serif; margin:0; padding:16px; text-align:center}
      .model{font-size:20px; font-weight:700}
      .fabric{font-size:16px; margin-top:2px}
      .sku{font-size:14px; margin-top:2px}
      .date{font-size:14px; margin-top:2px}
      svg{margin-top:10px}
    </style>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"><\/script>
    </head><body>
      <div class="model">${escapeHtml(it.nombre)}</div>
      <div class="fabric">Tela: ${escapeHtml(it.tela)}</div>
      <div class="sku">SKU: ${escapeHtml(it.sku)}</div>
      <div class="date">${escapeHtml(dateTxt)}</div>
      <svg id="b"></svg>
      <script>
        try{
          JsBarcode("#b","${escapeJs(it.code)}",{format:"CODE128",width:2,height:60,displayValue:true});
        }catch(e){}
        window.onload=function(){window.print();}
      <\/script>
    </body></html>
  `;
  w.document.write(html);
  w.document.close();
  w.focus();
});

/* ===== Configuraci√≥n y Herramientas: Import/Export ===== */
document.getElementById('btnExportTotals').addEventListener('click', ()=>{
  if(items.length===0){ alert("No hay datos"); return; }
  const headers = ["Modelo","Tela","SKU","C√≥digo","Cantidad","Fecha Alta"];
  const rows = items.map(i=>[
    i.nombre, i.tela, i.sku||"", i.code, i.cantidad,
    i.createdISO ? new Date(i.createdISO).toLocaleDateString() : ""
  ]);
  downloadCSV("inventario_totales.csv", headers, rows);
});
document.getElementById('btnExportMovs').addEventListener('click', ()=>{
  if(moves.length===0){ alert("No hay movimientos"); return; }
  const headers = ["Fecha","Hora","C√≥digo","SKU","Modelo","Tela","Delta","Tipo"];
  const rows = moves.map(m=>{
    const d = new Date(m.dateISO||Date.now());
    return [
      d.toLocaleDateString(), d.toLocaleTimeString(),
      m.code, m.sku||"", m.nombre, m.tela, m.delta, m.type
    ];
  });
  downloadCSV("inventario_movimientos.csv", headers, rows);
});

document.getElementById('btnImport').addEventListener('click', ()=>{
  const input = document.getElementById('csvFile');
  if(!input.files || !input.files[0]){ alert("Selecciona un archivo CSV"); return; }
  const file = input.files[0];
  const reader = new FileReader();
  reader.onload = (e)=>{
    const text = e.target.result;
    const rows = parseCSV(text);
    let imported=0, skipped=0;
    rows.forEach(r=>{
      const code = (r["C√≥digo"]||"").trim();
      const nombre=(r["Modelo"]||"").trim();
      const tela  =(r["Tela"]||"").trim();
      const sku   =(r["SKU"]||"").trim();
      const cant  = parseInt((r["Cantidad"]||"0").trim()||"0");
      const fecha = (r["Fecha"]||"").trim();

      if(!code){ skipped++; return; } // se respeta la regla: requiere C√≥digo
      const existing = items.find(i=>i.code===code);
      const createdISO = fecha? new Date(fecha).toISOString() : new Date().toISOString();

      if(existing){
        const delta = (cant - existing.cantidad);
        existing.nombre = nombre || existing.nombre;
        existing.tela   = tela   || existing.tela;
        existing.sku    = sku    || existing.sku;
        if(!Number.isNaN(cant)) existing.cantidad = cant;
        if(!existing.createdISO) existing.createdISO = createdISO;
        moves.push({dateISO:new Date().toISOString(), code:existing.code, sku:existing.sku, nombre:existing.nombre, tela:existing.tela, delta, type:'import'});
      }else{
        items.push({code, sku, nombre, tela, cantidad:(Number.isNaN(cant)?0:cant), createdISO});
        moves.push({dateISO:new Date().toISOString(), code, sku, nombre, tela, delta:(Number.isNaN(cant)?0:cant), type:'import'});
      }
      imported++;

      // actualizar contador KLL si los c√≥digos importados traen n√∫meros mayores
      const m = code.match(/^KLL-(\d{4,})$/i);
      if(m){ const n = parseInt(m[1]); if(n>=kllCounter) kllCounter = n+1; }
    });
    saveAll();
    renderInventory(); refreshLabelSelect();
    alert(`Importaci√≥n completada.\nFilas importadas: ${imported}\nOmitidas (sin C√≥digo): ${skipped}`);
  };
  reader.readAsText(file);
});

/* ===== Utilidades ===== */
function downloadCSV(filename, headers, rows){
  const csv = headers.join(",")+"\n"+rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(",")).join("\n");
  const blob = new Blob([csv],{type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download=filename; a.click();
  URL.revokeObjectURL(url);
}
function parseCSV(text){
  const lines = text.replace(/\r\n/g,"\n").replace(/\r/g,"\n").split("\n").filter(l=>l.trim().length>0);
  if(lines.length===0) return [];
  const headers = splitCSVLine(lines[0]);
  const out = [];
  for(let i=1;i<lines.length;i++){
    const cols = splitCSVLine(lines[i]);
    const obj = {};
    headers.forEach((h,idx)=> obj[h.trim()] = (cols[idx]||"").trim());
    out.push(obj);
  }
  return out;
}
function splitCSVLine(line){
  const res=[]; let cur=""; let inQ=false;
  for(let i=0;i<line.length;i++){
    const ch=line[i];
    if(ch==='"'){
      if(inQ && line[i+1]==='"'){ cur+='"'; i++; }
      else inQ=!inQ;
    }else if(ch===',' && !inQ){
      res.push(cur); cur="";
    }else{
      cur+=ch;
    }
  }
  res.push(cur);
  return res;
}
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }
function escapeJs(s){ return String(s).replace(/\\/g,'\\\\').replace(/`/g,'\\`').replace(/\$/g,'\\$').replace(/"/g,'\\"'); }
</script>
</body>
</html>