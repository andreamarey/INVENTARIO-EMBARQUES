<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Inventario de Muebles — KLL</title>

<!-- Librerías (HTTPS y válidas) -->
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

<style>
  :root{--primary:#2563eb;--primary-600:#1d4ed8;--bg:#f3f4f6;--card:#fff;--text:#111827;--muted:#6b7280;--ring:rgba(37,99,235,.12)}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
  header{background:var(--primary);color:#fff;text-align:center;padding:16px 12px;font-weight:700}
  .container{max-width:1100px;margin:18px auto;padding:0 12px}
  /* Tabs */
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
  .tab-btn{flex:1;min-width:150px;border:1px solid #e5e7eb;background:#fff;padding:12px;border-radius:10px;cursor:pointer;font-weight:700}
  .tab-btn.active{background:var(--primary);color:#fff;border-color:var(--primary)}
  .card{background:var(--card);border-radius:14px;padding:18px;box-shadow:0 8px 24px rgba(0,0,0,.05)}
  .hidden{display:none}
  h2{margin:0 0 12px 0;font-size:1.15rem}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  input,button,select{width:100%;padding:12px;border-radius:10px;border:1px solid #e5e7eb;background:#fff;outline:none}
  input:focus,select:focus{box-shadow:0 0 0 4px var(--ring);border-color:var(--primary)}
  button{background:var(--primary);color:#fff;border:none;font-weight:700;cursor:pointer}
  button:hover{background:var(--primary-600)}
  .muted{color:var(--muted);font-size:.9rem}
  /* Inventario */
  .inventory-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px}
  .item{border:1px solid #e5e7eb;border-radius:12px;padding:12px}
  .top{display:flex;justify-content:space-between;gap:8px}
  .name{font-weight:700}
  /* Etiqueta preview (dentro de la página) */
  .label-preview{border:1px solid #000;border-radius:8px;padding:12px;width:320px;max-width:100%;background:#fff}
  .label-preview .model{font-size:20px;font-weight:700}
  .label-preview .fabric{font-size:16px;margin-top:4px}
  .label-preview .date{font-size:14px;margin-top:4px}
  .label-preview svg{margin-top:10px}
</style>
</head>
<body>
<header>Inventario de Muebles — KLL</header>
<div class="container">

  <!-- Pestañas -->
  <div class="tabs">
    <button class="tab-btn active" data-tab="tab-registrar">Registrar</button>
    <button class="tab-btn" data-tab="tab-escanear">Escanear</button>
    <button class="tab-btn" data-tab="tab-inventario">Inventario</button>
    <button class="tab-btn" data-tab="tab-etiquetas">Etiquetas</button>
  </div>

  <!-- Registrar -->
  <section id="tab-registrar" class="card">
    <h2>Registrar producto</h2>
    <div class="row">
      <input id="newName" placeholder="Modelo (ej. Sillón Roma)">
      <input id="newFabric" placeholder="Tela (ej. Lino Beige)">
    </div>
    <div class="row">
      <button id="btnGenerate">Generar código KLL y guardar</button>
    </div>
    <div class="muted">Crea el producto (cantidad=1), se añade al inventario y podrás imprimir su etiqueta.</div>
  </section>

  <!-- Escanear -->
  <section id="tab-escanear" class="card hidden">
    <h2>Escanear código (Code128 / QR)</h2>
    <div class="row">
      <div id="reader" style="width:100%;max-width:420px;margin:auto"></div>
    </div>
    <div class="row" style="margin-top:10px">
      <input id="scanCode" placeholder="Código leído" readonly>
      <input id="scanName" placeholder="Modelo" readonly>
      <input id="scanFabric" placeholder="Tela" readonly>
      <input id="scanQty" placeholder="Cantidad total" readonly>
    </div>
    <div class="muted">Si el código existe en tu catálogo, el sistema sumará la cantidad automáticamente.</div>
  </section>

  <!-- Inventario -->
  <section id="tab-inventario" class="card hidden">
    <h2>Inventario</h2>
    <div class="row" style="margin-bottom:10px">
      <input id="searchInput" placeholder="Buscar por modelo, tela o código">
      <input type="month" id="filterMonth">
      <button id="btnCSV">Exportar CSV</button>
    </div>
    <div id="inventory" class="inventory-grid"></div>
  </section>

  <!-- Etiquetas -->
  <section id="tab-etiquetas" class="card hidden">
    <h2>Etiquetas</h2>
    <div class="row">
      <select id="labelSelect"></select>
      <button id="btnPrintLabel">Imprimir etiqueta seleccionada</button>
    </div>
    <div id="labelPreviewWrap" style="margin-top:12px">
      <div id="labelPreview" class="label-preview" style="display:none">
        <div class="model" id="pModel"></div>
        <div class="fabric" id="pFabric"></div>
        <div class="date" id="pDate"></div>
        <svg id="pBarcode"></svg>
      </div>
      <div class="muted" id="noLabelMsg">Selecciona un producto para ver la vista previa.</div>
    </div>
  </section>

</div>

<script>
(function(){
  /*================= Estado & Persistencia =================*/
  let productos = {}; // codigo -> {nombre, tela}
  let inventory = []; // [{barcode, nombre, tela, cantidad, dateISO}]
  let kllCounter = 1; // contador incremental para KLL-####

  // Cargar al inicio
  try{
    const p = localStorage.getItem('productos');
    const inv = localStorage.getItem('inventory');
    const c  = localStorage.getItem('kllCounter');
    productos = p ? JSON.parse(p) : {};
    inventory = inv ? JSON.parse(inv) : [];
    kllCounter = c ? parseInt(c) : 1;
  }catch(e){
    productos = {}; inventory = []; kllCounter = 1;
  }

  function saveAll(){
    localStorage.setItem('productos', JSON.stringify(productos));
    localStorage.setItem('inventory', JSON.stringify(inventory));
    localStorage.setItem('kllCounter', String(kllCounter));
  }

  /*================= Tabs robustos =================*/
  const tabButtons = document.querySelectorAll('.tab-btn');
  const sections = document.querySelectorAll('section.card');
  let scanner = null; // se inicia bajo demanda

  function showTab(tabId){
    try{
      tabButtons.forEach(b => b.classList.toggle('active', b.dataset.tab === tabId));
      sections.forEach(s => s.classList.toggle('hidden', s.id !== tabId));

      // Escáner bajo demanda
      if (tabId === 'tab-escanear') {
        ensureScannerStarted();
      } else {
        ensureScannerStopped();
      }

      if (tabId === 'tab-etiquetas') {
        refreshLabelSelect();
      }
    }catch(e){
      console.error("Error al cambiar de pestaña:", e);
      alert("Ocurrió un error al cambiar de pestaña. Revisa la consola (F12).");
    }
  }

  tabButtons.forEach(btn=>{
    btn.addEventListener('click', () => showTab(btn.dataset.tab));
  });
  // Mostrar Registrar al arrancar
  showTab('tab-registrar');

  /*================= Generar / Registrar =================*/
  function nextKLL(){
    const code = "KLL-" + String(kllCounter).padStart(4,'0');
    kllCounter += 1;
    return code;
  }

  function generateProduct(){
    const nombre = document.getElementById('newName').value.trim();
    const tela   = document.getElementById('newFabric').value.trim();
    if(!nombre || !tela){ alert("Ingresa modelo y tela"); return; }

    const code = nextKLL();
    productos[code] = { nombre, tela };

    // Agregar al inventario con cantidad 1 y fecha actual
    const nowISO = new Date().toISOString();
    inventory.push({ barcode:code, nombre, tela, cantidad:1, dateISO:nowISO });

    // limpiar
    document.getElementById('newName').value = "";
    document.getElementById('newFabric').value = "";

    saveAll();
    renderInventory();
    refreshLabelSelect();
    alert(`Producto guardado con código ${code}`);
  }
  document.getElementById('btnGenerate').addEventListener('click', generateProduct);

  /*================= Escáner (lazy start) =================*/
  function ensureScannerStarted(){
    if (scanner) return;
    try{
      scanner = new Html5QrcodeScanner("reader", { fps:10, qrbox:250 });
      scanner.render(onScanSuccess);
    }catch(e){
      console.error(e);
      alert("No pude iniciar la cámara. Revisa permisos o prueba con Chrome.");
    }
  }
  function ensureScannerStopped(){
    // Html5QrcodeScanner no expone stop sencillo; este patrón evita re-crear múltiples instancias.
    // Si necesitas liberar cámara entre tabs, podemos migrar a Html5Qrcode (nivel más bajo) y manejar start/stop manual.
  }

  function onScanSuccess(decodedText){
    document.getElementById('scanCode').value = decodedText;

    if(productos[decodedText]){
      const prod = productos[decodedText];
      let item = inventory.find(i=>i.barcode===decodedText);
      if(item){
        item.cantidad += 1;
      }else{
        item = { barcode:decodedText, nombre:prod.nombre, tela:prod.tela, cantidad:1, dateISO:new Date().toISOString() };
        inventory.push(item);
      }
      document.getElementById('scanName').value = prod.nombre;
      document.getElementById('scanFabric').value = prod.tela;
      document.getElementById('scanQty').value = item.cantidad;

      saveAll();
      renderInventory();
    }else{
      document.getElementById('scanName').value = "No registrado";
      document.getElementById('scanFabric').value = "";
      document.getElementById('scanQty').value = "";
    }
  }

  /*================= Inventario =================*/
  function renderInventory(){
    const wrap = document.getElementById('inventory');
    if(!wrap) return;
    wrap.innerHTML = "";
    const q = (document.getElementById('searchInput')?.value || "").toLowerCase();
    const m = document.getElementById('filterMonth')?.value || ""; // YYYY-MM

    const data = inventory
      .filter(i=>{
        const okM = !m || (i.dateISO||"").slice(0,7)===m;
        const okQ = !q || i.nombre.toLowerCase().includes(q) || i.tela.toLowerCase().includes(q) || i.barcode.toLowerCase().includes(q);
        return okM && okQ;
      })
      .sort((a,b)=>(b.dateISO||"").localeCompare(a.dateISO||""));

    data.forEach(i=>{
      const card = document.createElement('div');
      card.className = 'item';
      const dateTxt = i.dateISO ? new Date(i.dateISO).toLocaleDateString() : "-";
      card.innerHTML = `
        <div class="top">
          <div class="name">${escapeHtml(i.nombre)}</div>
          <div class="muted">Cant: ${i.cantidad}</div>
        </div>
        <div class="muted">Tela: ${escapeHtml(i.tela)}</div>
        <div class="muted">Código: ${escapeHtml(i.barcode)} · Fecha: ${escapeHtml(dateTxt)}</div>
        <svg class="bc" jsbarcode-format="CODE128" jsbarcode-value="${escapeAttr(i.barcode)}" jsbarcode-height="40"></svg>
      `;
      wrap.appendChild(card);
      try{ JsBarcode(card.querySelector('svg')).init(); }
      catch(e){ console.warn("No pude renderizar el código de barras:", e); }
    });
  }
  document.getElementById('searchInput').addEventListener('input', renderInventory);
  document.getElementById('filterMonth').addEventListener('change', renderInventory);

  // Exportar CSV
  function exportCSV(){
    if(inventory.length===0){alert("No hay datos"); return;}
    const headers = ["Modelo","Tela","Cantidad","Código","Fecha"];
    const rows = inventory.map(i=>[
      i.nombre, i.tela, i.cantidad, i.barcode,
      i.dateISO ? new Date(i.dateISO).toLocaleDateString() : ""
    ]);
    const csv = headers.join(",")+"\n"+rows.map(r=>r.map(s=>`"${String(s).replace(/"/g,'""')}"`).join(",")).join("\n");
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = "inventario_kll.csv"; a.click();
    URL.revokeObjectURL(url);
  }
  document.getElementById('btnCSV').addEventListener('click', exportCSV);

  /*================= Etiquetas =================*/
  function refreshLabelSelect(){
    const sel = document.getElementById('labelSelect');
    if(!sel) return;
    const prev = sel.value;
    sel.innerHTML = "";
    inventory.forEach(i=>{
      const opt = document.createElement('option');
      opt.value = i.barcode;
      opt.textContent = `${i.nombre} · ${i.tela} · ${i.barcode}`;
      sel.appendChild(opt);
    });
    if(prev && [...sel.options].some(o=>o.value===prev)) sel.value = prev;
    onLabelSelectChange();
  }

  function onLabelSelectChange(){
    const sel = document.getElementById('labelSelect');
    const preview = document.getElementById('labelPreview');
    const msg = document.getElementById('noLabelMsg');
    if(!sel.value){ preview.style.display="none"; msg.style.display="block"; return; }
    const item = inventory.find(i=>i.barcode===sel.value);
    if(!item){ preview.style.display="none"; msg.style.display="block"; return; }

    msg.style.display="none";
    preview.style.display="block";
    document.getElementById('pModel').textContent = item.nombre;
    document.getElementById('pFabric').textContent = item.tela;
    document.getElementById('pDate').textContent = item.dateISO ? new Date(item.dateISO).toLocaleDateString() : "";
    try{
      JsBarcode("#pBarcode", item.barcode, {format:"CODE128", width:2, height:60, displayValue:true});
    }catch(e){
      console.warn("No pude pintar el barcode en preview:", e);
    }
  }
  document.getElementById('labelSelect').addEventListener('change', onLabelSelectChange);

  function printSelectedLabel(){
    const sel = document.getElementById('labelSelect');
    if(!sel.value){ alert("Selecciona un producto"); return; }
    const item = inventory.find(i=>i.barcode===sel.value);
    if(!item){ alert("Producto no encontrado"); return; }

    const w = window.open('', '', 'width=420,height=360');
    const dateTxt = item.dateISO ? new Date(item.dateISO).toLocaleDateString() : "";
    let html = `
      <html><head><title>Etiqueta ${escapeHtml(item.barcode)}</title>
      <style>
        body{font-family:Arial, sans-serif; margin:0; padding:16px; text-align:center}
        .label{border:1px solid #000; padding:10px; width:320px; margin:0 auto}
        .model{font-size:20px; font-weight:700}
        .fabric{font-size:16px; margin-top:4px}
        .date{font-size:14px; margin-top:4px}
        svg{margin-top:10px}
      </style>
      <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
      </head><body>
        <div class="label">
          <div class="model">${escapeHtml(item.nombre)}</div>
          <div class="fabric">${escapeHtml(item.tela)}</div>
          <div class="date">${escapeHtml(dateTxt)}</div>
          <svg id="code"></svg>
        </div>
        <script>
          try{
            JsBarcode("#code","${escapeJs(item.barcode)}",{format:"CODE128",width:2,height:60,displayValue:true});
          }catch(e){}
          window.onload = function(){ window.print(); }
        <\/script>
      </body></html>
    `;
    w.document.write(html);
    w.document.close();
    w.focus();
  }
  document.getElementById('btnPrintLabel').addEventListener('click', printSelectedLabel);

  // Utils de escape
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }
  function escapeAttr(s){ return String(s).replace(/"/g,'&quot;'); }
  function escapeJs(s){ return String(s).replace(/\\/g,'\\\\').replace(/`/g,'\\`').replace(/\$/g,'\\$').replace(/"/g,'\\"'); }

})();
</script>
</body>
</html>