<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Inventario de Muebles</title>

<!-- Librerías -->
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

<style>
  :root {
    --primary:#2563eb; --primary-600:#1d4ed8; --bg:#f3f4f6; --card:#ffffff; --text:#111827; --muted:#6b7280; --ring: rgba(37,99,235,.15);
  }
  *{box-sizing:border-box}
  body{margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:var(--bg); color:var(--text);}
  header{background:var(--primary); color:#fff; padding:20px; text-align:center; font-weight:700; letter-spacing:.3px}
  .container{max-width:1100px; margin:24px auto; padding:0 16px}
  .grid{display:grid; gap:16px}
  .grid-2{grid-template-columns: repeat(auto-fit,minmax(320px,1fr));}
  .card{background:var(--card); border-radius:14px; padding:18px; box-shadow:0 8px 24px rgba(0,0,0,.06), 0 1px 2px rgba(0,0,0,.05);}
  h2{margin:0 0 12px 0; font-size:1.15rem}
  .row{display:flex; gap:10px; flex-wrap:wrap}
  input, select, button{width:100%; padding:12px 14px; border-radius:10px; border:1px solid #e5e7eb; background:#fff; color:var(--text); outline:none}
  input:focus, select:focus{box-shadow:0 0 0 4px var(--ring); border-color: var(--primary)}
  button{background:var(--primary); color:#fff; border:none; font-weight:700; cursor:pointer}
  button:hover{background:var(--primary-600)}
  .muted{color:var(--muted); font-size:.9rem}
  .inventory-list{display:grid; grid-template-columns: repeat(auto-fit,minmax(280px,1fr)); gap:14px}
  .product-card{border:1px solid #e5e7eb; border-radius:12px; padding:12px}
  .product-card .top{display:flex; align-items:center; justify-content:space-between; gap:10px}
  .product-card .name{font-weight:700}
  .badge{background:#eef2ff; color:#3730a3; padding:4px 8px; border-radius:999px; font-size:.75rem}
  .controls{display:flex; gap:10px; flex-wrap:wrap; margin-top:8px}
  .controls > *{flex:1}
  #reader{width:100%; max-width:420px; margin:auto}
  .section-title{display:flex; align-items:center; justify-content:space-between}
  .checkbox{display:flex; gap:8px; align-items:center}
</style>
</head>
<body>
<header>Inventario de Muebles</header>
<div class="container">

<!-- Generador -->
<div class="card">
  <div class="section-title">
    <h2>Generador de códigos</h2>
    <div class="muted">Crea el código, se guarda y podrás imprimir la etiqueta</div>
  </div>
  <div class="row">
    <input id="newName" placeholder="Nombre del mueble (ej. Silla Oslo)">
    <input id="newFabric" placeholder="Tela (ej. Lino Beige)">
  </div>
  <div class="row">
    <button onclick="generateProduct()">Generar código y agregar</button>
  </div>
</div>

<!-- Buscador -->
<div class="card">
  <h2>Buscar producto</h2>
  <input type="text" id="searchInput" placeholder="Buscar por nombre, tela o código" oninput="updateInventoryList()">
</div>

<!-- Escáner -->
<div class="card grid grid-2">
  <div>
    <h2>Escanear código</h2>
    <div id="reader"></div>
  </div>
  <div>
    <h2>Resultado del escaneo</h2>
    <div class="row">
      <input id="scanCode" placeholder="Código leído" readonly>
      <input id="scanName" placeholder="Nombre" readonly>
      <input id="scanFabric" placeholder="Tela" readonly>
      <input id="scanQty" placeholder="Cantidad" readonly>
    </div>
    <div class="muted">Al leer un código guardado, se rellenan nombre, tela y cantidad automáticamente.</div>
  </div>
</div>

<!-- Inventario -->
<div class="card">
  <div class="section-title">
    <h2>Inventario</h2>
    <div class="row" style="gap:8px; width:420px; max-width:100%">
      <input type="month" id="filterMonth" onchange="updateInventoryList()">
      <button onclick="downloadCSV()">Exportar CSV</button>
      <button onclick="printAllLabels()">Imprimir todas las etiquetas</button>
    </div>
  </div>
  <div id="inventory" class="inventory-list"></div>
</div>

<script>
let productos = {}; // diccionario: codigo -> {nombre, tela}
let inventory = []; // [{barcode, nombre, tela, cantidad, dateISO}]
loadData();

// Generar código único con prefijo KLL
function generarCodigoUnico(){
  const random = Math.floor(10000 + Math.random()*90000);
  return "KLL"+random;
}

// Generar producto
function generateProduct(){
  const nombre = document.getElementById('newName').value.trim();
  const tela = document.getElementById('newFabric').value.trim();
  if(!nombre || !tela){ alert("Ingresa nombre y tela"); return; }

  const code = generarCodigoUnico();
  productos[code] = {nombre, tela};

  // Agregar al inventario con cantidad 1
  inventory.push({barcode: code, nombre, tela, cantidad:1, dateISO:new Date().toISOString()});

  document.getElementById('newName').value="";
  document.getElementById('newFabric').value="";

  saveData();
  updateInventoryList();
}

// Escáner
function onScanSuccess(decodedText){
  document.getElementById('scanCode').value = decodedText;
  if(productos[decodedText]){
    const prod = productos[decodedText];

    // Revisar si ya existe en inventario
    let invItem = inventory.find(i=>i.barcode===decodedText);
    if(invItem){
      invItem.cantidad += 1;
    } else {
      invItem = {barcode:decodedText, nombre:prod.nombre, tela:prod.tela, cantidad:1, dateISO:new Date().toISOString()};
      inventory.push(invItem);
    }

    document.getElementById('scanName').value = prod.nombre;
    document.getElementById('scanFabric').value = prod.tela;
    document.getElementById('scanQty').value = invItem.cantidad;

    saveData();
    updateInventoryList();
  } else {
    document.getElementById('scanName').value="No registrado";
    document.getElementById('scanFabric').value="";
    document.getElementById('scanQty').value="";
  }
}
const scanner = new Html5QrcodeScanner("reader",{fps:10, qrbox:250});
scanner.render(onScanSuccess);

// Actualizar inventario
function updateInventoryList(){
  const wrap = document.getElementById('inventory');
  wrap.innerHTML="";
  const filter = document.getElementById('filterMonth').value;
  const search = document.getElementById('searchInput').value.toLowerCase();

  const data = inventory.filter(item=>{
    const matchMonth = !filter || (item.dateISO||"").slice(0,7)===filter;
    const matchSearch = !search || item.nombre.toLowerCase().includes(search) ||
                        item.tela.toLowerCase().includes(search) ||
                        item.barcode.toLowerCase().includes(search);
    return matchMonth && matchSearch;
  });

  data.forEach(item=>{
    const dateTxt = item.dateISO ? new Date(item.dateISO).toLocaleDateString() : "-";
    const card = document.createElement('div');
    card.className = "product-card";
    card.innerHTML = `
      <div class="top">
        <div class="name">${item.nombre}</div>
        <div class="muted">Cantidad: ${item.cantidad}</div>
      </div>
      <div class="muted">Tela: ${item.tela}</div>
      <div class="muted">Código: ${item.barcode} | Fecha: ${dateTxt}</div>
      <svg class="barcode" jsbarcode-format="CODE128" jsbarcode-value="${item.barcode}" jsbarcode-height="40"></svg>
    `;
    wrap.appendChild(card);
    JsBarcode(card.querySelector("svg")).init();
  });
}

// Guardar y cargar datos localmente
function saveData(){
  localStorage.setItem("productos", JSON.stringify(productos));
  localStorage.setItem("inventory", JSON.stringify(inventory));
}
function loadData(){
  const p = localStorage.getItem("productos");
  if(p) productos = JSON.parse(p);
  const i = localStorage.getItem("inventory");
  if(i) inventory = JSON.parse(i);
  updateInventoryList();
}

// Exportar CSV
function downloadCSV(){
  if(inventory.length===0){alert("No hay datos"); return;}
  const headers = ["Nombre","Tela","Cantidad","Código","Fecha"];
  const rows = inventory.map(i=>[i.nombre,i.tela,i.cantidad,i.barcode,new Date(i.dateISO).toLocaleDateString()]);
  let csv = headers.join(",")+"\n"+rows.map(r=>r.join(",")).join("\n");
  const blob = new Blob([csv],{type:"text/csv"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download="inventario_muebles.csv";
  a.click();
  URL.revokeObjectURL(url);
}

// Imprimir etiquetas
function printAllLabels(){
  if(inventory.length === 0){ alert("No hay productos para imprimir"); return; }

  const printWindow = window.open('', '', 'width=800,height=600');
  printWindow.document.write('<html><head><title>Etiquetas</title>');
  printWindow.document.write('<style>');
  printWindow.document.write(`
    body{font-family: Arial, sans-serif; margin:20px;}
    .label{border:1px solid #000; border-radius:8px; padding:12px; width:300px; margin-bottom:16px;}
    .label h2{margin:0; font-size:1.2rem;}
    .label .fabric, .label .code, .label .date{text-align:left; margin:2px 0;}
    svg{margin-top:8px;}
  `);
  printWindow.document.write('</style></head><body>');

  inventory.forEach(item => {
    const dateTxt = new Date(item.dateISO).toLocaleDateString();
    printWindow.document.write(`
      <div class="label">
        <h2>${item.nombre}</h2>
        <div class="fabric">Tela: ${item.tela}</div>
        <div class="code">Código: ${item.barcode}</div>
        <div class="date">Fecha: ${dateTxt}</div>
        <svg jsbarcode-format="CODE128" jsbarcode-value="${item.barcode}" jsbarcode-height="40"></svg>
      </div>
    `);
  });

  printWindow.document.write('<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>');
  printWindow.document.write('<script>JsBarcode(document.querySelectorAll("svg")).init();</script>');
  printWindow.document.write('</body></html>');
  printWindow.document.close();
  printWindow.focus();
  printWindow.print();
}
</script>
</body>
</html>
